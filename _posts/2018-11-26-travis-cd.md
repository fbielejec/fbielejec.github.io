---
layout: post
title: Continuous Delivery with Travis and leiningen
comments: true
categories:
- automation
- DevOps
- CI
- Continuous Integration
- CD
- Continuous Delivery
- Travis
- git
- Leiningen
---

# <a name="intro">Intro</a>

The work involved in deploying a release version of your plugin/library can be tedious and difficult to perform consistently from one release to another, as it involves a lot of repeatable steps.
Fortunately it is also ripe for automation, which is why in this post we will go over the steps neccessart to setup a CI/CD pipeline, which ends with a deployment to clojars.

# <a name="requirements">Requirements</a>

For this tutorial we will assume Github repo is used for version control of your project with [Travis](https://travis-ci.org) enabled as a Continuous Integration tool and [Leiningen](https://leiningen.org/) as a Clojure build tool.

Ideally you would also be using some form of [git-flow](https://danielkummer.github.io/git-flow-cheatsheet/) or other branch-based feature model for developing new versions.

# <a name="release">Setting up lein-release to work with clojars</a>

Start by creating a separate profile on [Clojars](https://clojars.org/).
Deploying and to clojars repository needs authentication credentials, in the typical form of a username/password.
We will specify to have these credentials looked up in the environment by using a namespaced keyword.

<a name="deploy-repositories">Add the following `:deploy-repositories` specification to your `project.clj`:</a>
```edn
:deploy-repositories [["snapshots" {:url "https://clojars.org/repo"
                                    :username :env/clojars_username
                                    :password :env/clojars_password
                                    :sign-releases false}]
                      ["releases"  {:url "https://clojars.org/repo"
                                    :username :env/clojars_username
                                    :password :env/clojars_password
                                    :sign-releases false}]]
```

If the project's current version is a `SNAPSHOT`, it will default to deploying to the "snapshots" repository; otherwise it will default to the "releases" repository.
`:sign-releases` key set to false is there to make sure that the process doesn't hang while prompting for GPG passphrase.

Once we have the repositories and the user credentials for them configured, we can specify the steps for actually deploying the release version.

<a name="release-tasks">Include the following `:release-tasks` key in your `project.clj`:</a>

```edn
:release-tasks [["vcs" "assert-committed"]
                ["change" "version" "leiningen.release/bump-version" "release"]
                ["shell" "git" "commit" "-am" "Version ${:version} [ci skip]"]
                ["vcs" "tag" "v" "--no-sign"]
                ["deploy"]
                ["change" "version" "leiningen.release/bump-version"]
                ["shell" "git" "commit" "-am" "Version ${:version} [ci skip]"]
                ["vcs" "push"]]
```

This specification results in the following tasks when deploying:

* First a `vcs` task checks if there are any uncommited changes (process bails if true).
* Second a `change` task removes whatever qualifier is on the version in the project.clj (e.g. `SNAPSHOT`),
* Next `shell` and `vcs` tasks are run, respectively, to commit this change and then to tag the repository with the release version number.
* Then a `deploy` task pushes the artifact to the "releases" repository.
* The `change` task is run once more to "bump" the version number in project.clj. Which version level is decided by the argument passed to `lein release`, (e.g. `:major`, `:minor`, `:patch`)
* Finally, `shell` and `vcs` tasks are run once more to commit the version change to project.clj and then push these two new commits to the default remote repository.

---
**Note**

For the `shell` task you need to add the folowing plugin to your `project.clj`:
```edn
:plugins [lein-shell "0.5.0"]
```

---

At this point we can test if the release works as expected by releasing a test version locally.
Specify the credentails and issue the following command:

```bash
env CLOJARS_USERNAME=<username> CLOJARS_PASSWORD=<password> lein release :patch
```

# <a name="travis">Setting up Travis</a>

Travis build process is configured by adding a `.travis.yml` file inside your repository, e.g.:

```yaml
sudo: required
dist: trusty
language: clojure
script: lein test
```

This very basic file contains information on the language of the repository (clojure) and the test command (`lein test`).
Travis supports storing encrypted values in this file, such as environment variables, only readable by Travis CI, meaning the repositroy owner does not need to keep any private keys.

We will use this to store the credentials to access clojars during CI/CD build.
Start by installing the travis-cli and its dependencies:

```bash
sudo apt-get install ruby-dev
gem install travis
```

Now in the root of your repository, where the `.travis.yml` file resides, run these commands, substituting placeholders with the real clojars credentials:

```bash
travis encrypt CLOJARS_USERNAME=<username> --add
travis encrypt CLOJARS_PASSWORD=<password> --add
```

This will add the encrypted environment variables to the `.travis.yml` file.

---
**Note**

Travis documentation spefices that all the special characters need to be escaped when econding:
https://docs.travis-ci.com/user/encryption-keys/#note-on-escaping-certain-symbols

---

Travis readily supports deploymments to various [providers](https://docs.travis-ci.com/user/deployment/), alas not to Clojars.
To deploy to clojars we will use a general-purpose script provider.

<a name="deploy-step">Specify the deploy step in the `.travis.yml` file:</a>

```yaml
deploy:
  - provider: script
    skip_cleanup: true
    script: lein release :patch
    on:
      branch: master
```

Travis will execute `lein release :patch` on the master branch of your repository if the CI build was successful.
If the deploy command returns a non-zero status, deployment is considered a failure, and the build is marked as `errored`.

## <a name="travis-github">Authenticating with Github from Travis</a>

There is one more problem which needs addressing.
As you recall when specifying the [tasks](#release-tasks), we push two commits and a tagged release to the repository.
This is not a a problem when done locally, but in the CI/CD environment we will push from an unauthenticated Travis server.

This is where Github's [access tokens](https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/) come in handy.
You can generate one from [here](https://github.com/settings/tokens).
Select `public_repo` as the token permissons.

Next, encrypt and add the token as an environment variable to the `.travis.yml` file:

```bash
travis encrypt GH_TOKEN=<your_token_here> --add
```
Next we need to switch to an origin which uses the token to authenticate.

<a name="after-success">Specify the `after-success` step in the `.travis.yml` file:</a>

```yaml
after_success:
- git config --global user.email "travis@travis-ci.org"
- git config --global user.name "Travis CI"
- git remote rm origin
- git remote add origin https://${GH_TOKEN}@github.com/<organisation>/<repo>.git > /dev/null 2>&1
```

Placeholders need to be replaced with the value corresponding to your project.
**GH_TOKEN** will be substituted inside the build server with the un-encrypted token carrying commit rights, and we pipe the output to the `/dev/null` to avoid leaking it in the Travis's build logs.

---
**Note**

Alternatively these steps can be done as part of the Travis's [`deploy` step](#deploy-step) script.

---

# <a name="readme badge">Clojars badge</a>

As a final bonus Clojars creates version badges, which always point to the latest version of your library, saving you the need to manually alter projects documentation, you can display one by adding to the project's README:

```
[![Clojars Project](https://img.shields.io/clojars/v/<organisation>/<project>.svg)](https://clojars.org/<organisation>/project)
```

Thanks for reading!.
